# 風揺れエフェクト エディター v6 - レイヤー固有のピン対応版

## 🆕 v6の新機能

### 🎯 レイヤー・フォルダごとの独立したピン管理

**問題点を完全に解決！**
- ✅ ピンモードのチェックを外してもピンデータは保持されます
- ✅ 各レイヤーが個別のピン配列を持ちます
- ✅ 各フォルダーも個別のピン配列を持ちます
- ✅ レイヤーを選択すると、そのレイヤーのピンが表示されます

### 🎨 エフェクトの重ね掛け機能

**レイヤー個体のエフェクト + フォルダーのエフェクト**

```
📁 髪全体フォルダ（エフェクトON + ピン3個：全体的な大きな揺れ）
├─ 前髪（エフェクトON + ピン2個：個別の細かい揺れ）
├─ 横髪（エフェクトON + ピン1個：個別の細かい揺れ）
└─ 後髪（エフェクトOFF：揺れない）
```

この例では：
- **前髪**: レイヤー固有のエフェクト（ピン2個）→ フォルダのエフェクト（ピン3個）の順に適用
- **横髪**: レイヤー固有のエフェクト（ピン1個）→ フォルダのエフェクト（ピン3個）の順に適用
- **後髪**: フォルダのエフェクト（ピン3個）のみ適用

## 📝 使い方

### ピンの配置
1. レイヤーを選択
2. 「📍 ピンモード」をチェック
3. 「➕ 画像をクリックしてピンを追加」をクリック
4. 固定したい位置をクリック
5. かわいいクマさんが配置されます！

### レイヤーごとのピン管理
- レイヤーを切り替えると、そのレイヤーのピンが表示されます
- ピンモードのチェックを外しても、ピンデータは保持されます
- 各レイヤー・各フォルダーは独立したピン配列を持ちます

### フォルダ機能
1. Shiftキーを押しながら複数のレイヤーをクリックして選択
2. 「📁 選択をフォルダにまとめる」ボタンをクリック
3. フォルダが作成されます
4. フォルダにもエフェクトとピンを設定できます

### エフェクトの重ね掛け
- **レイヤー個体のエフェクト**: レイヤー固有の設定とピン
- **フォルダーのエフェクト**: フォルダー固有の設定とピン
- 両方が有効な場合、レイヤーのエフェクト → フォルダーのエフェクトの順に適用されます

## 🔧 修正内容

### データ構造
- 各レイヤー: `{ ..., effectEnabled, pinMode, pins: [] }`
- 各フォルダー: `{ ..., effectEnabled, pinMode, pins: [] }`

### ピン管理
- ピンモードのチェックを外してもピンデータは削除されません
- レイヤー選択時に、そのレイヤーのピンが自動的に表示されます
- ピンリストは現在選択中のレイヤーのピンを表示します

### エフェクト適用
- `getFlattenedLayers()`: 各レイヤーに親フォルダのリストを保持
- 描画時: レイヤーのエフェクト → 各親フォルダーのエフェクトを順番に重ね掛け
- 書き出し時も同様に重ね掛けを実行

## 📦 ファイル構成

- `index.html` - メインHTML
- `styles.css` - スタイルシート
- `app.js` - メインロジック（完全修正版）
- `pins/` - クマさんピン画像（5種類）
- `WIND_SWAY_ALGORITHM.md` - 技術仕様書
- `README_v6.md` - このファイル

## 💡 活用例

### キャラクターの髪
```
📁 髪全体（エフェクトON：大きく揺れる）
├─ 前髪左（エフェクトON + ピン固定：根元固定で細かく揺れる）
├─ 前髪中央（エフェクトON + ピン固定：根元固定で細かく揺れる）
└─ 前髪右（エフェクトON + ピン固定：根元固定で細かく揺れる）
```

→ 毛束ごとに根元を固定しながら細かく揺らし、全体的にも大きく揺れる自然な動き

### 複雑な衣装
```
📁 スカート（エフェクトON：全体の大きな揺れ）
├─ スカート上部（エフェクトOFF + ピン固定：完全に固定）
├─ スカート中央（エフェクトON + ピン：ウエスト固定で揺れる）
└─ スカート裾（エフェクトON：自由に大きく揺れる）
```

→ ウエスト部分を固定しながら、中央から裾にかけて自然に揺れる

### 多層背景
```
背景1（エフェクトOFF：固定）
背景2（エフェクトON：ゆっくり揺れる）
📁 キャラクター（エフェクトON：普通に揺れる）
├─ 体（エフェクトOFF：固定）
├─ 髪（エフェクトON + ピン）
└─ 服（エフェクトON + ピン）
背景3（エフェクトON：速く揺れる）
```

→ パララックス効果のある奥行きのある動き

## 🎉 解決した問題

### 問題1: チェックを外すとピンがリセット
**解決**: ピンモードのチェックを外しても、各レイヤー/フォルダの`pins`配列はそのまま保持されます。チェックを入れ直すと、保存されていたピンが再表示されます。

### 問題2: ピンが全レイヤー共通
**解決**: 各レイヤー・各フォルダーが独立した`pins`配列を持つようになりました。レイヤーを選択すると、そのレイヤーのピンだけが表示されます。

### 問題3: エフェクトの適用方法
**解決**: レイヤー個体のエフェクトとフォルダーのエフェクトを別々に管理し、重ね掛けできるようになりました。

## 🔍 技術詳細

### レイヤーデータ構造
```javascript
{
    type: 'image',
    id: 123,
    img: Image,
    name: '前髪.png',
    width: 800,
    height: 600,
    effectEnabled: true,  // レイヤー固有のエフェクト
    pinMode: false,       // ピンモード（UI用）
    pins: [               // レイヤー固有のピン配列
        { id: 456, position: 20, range: 30, x: 100, y: 50 }
    ],
    visible: true
}
```

### フォルダーデータ構造
```javascript
{
    type: 'folder',
    id: 789,
    name: '髪全体',
    children: [...],      // 子レイヤーの配列
    effectEnabled: true,  // フォルダー固有のエフェクト
    pinMode: false,
    pins: [               // フォルダー固有のピン配列
        { id: 999, position: 10, range: 40, x: 200, y: 30 }
    ],
    visible: true,
    collapsed: false
}
```

### エフェクトの適用順序
1. レイヤーの画像を読み込み
2. レイヤーの`effectEnabled`がtrueなら、レイヤーの`pins`を使ってエフェクトを適用
3. 親フォルダーを順番に確認
4. 各親フォルダーの`effectEnabled`がtrueなら、そのフォルダーの`pins`を使ってエフェクトを重ね掛け
5. 最終結果を描画

## 🚀 今後の展開

- ドラッグ&ドロップでフォルダ間の移動
- ピンの位置をドラッグで調整
- ピンごとの影響範囲をビジュアルで調整
- エフェクトのプレビュー強化

---

**風揺れエフェクト エディター v6**  
各レイヤー・フォルダごとに独立したピンとエフェクトを持ち、複雑な重ね掛けが可能になりました！
